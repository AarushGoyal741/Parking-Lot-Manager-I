<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - View Users</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_users.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¥ All Registered Users</h1>

        <form method="GET" class="filters">
            <input type="text" name="search" placeholder="Search by username or email" value="{{ search }}">
            <input type="date" name="date" value="{{ date_filter }}">
            <button type="submit">ğŸ” Filter</button>
        </form>

        {% for entry in user_data %}
            <div class="user-card">
                <div class="user-header">
                    <h2>{{ entry.user.username }}</h2>
                    <form action="{{ url_for('delete_user', user_id=entry.user.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this user? This will permanently delete all their bookings and active reservations.')">
                        <button type="submit" class="delete-btn">Delete</button>
                    </form>
                </div>
                <p><strong>Email:</strong> {{ entry.user.email }}</p>

                {% if entry.transactions %}
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ“ Lot</th>
                                <th>ğŸš— Vehicle</th>
                                <th>ğŸ•“ Entry</th>
                                <th>ğŸ•” Exit</th>
                                <th>ğŸ’° Cost</th>
                                <th>â­ Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for txn in entry.transactions %}
                                <tr>
                                    <td>{{ txn.lot_location }}</td>
                                    <td>{{ txn.vehicle_number }}</td>
                                    <td>{{ txn.entry_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ txn.exit_time.strftime('%Y-%m-%d %H:%M') if txn.exit_time else '-' }}</td>
                                    <td>
                                        {% if txn.cost is not none %}
                                            â‚¹{{ "%.2f"|format(txn.cost) }}
                                        {% else %}
                                            â‚¹0.00
                                        {% endif %}
                                    </td>
                                    <td>{{ txn.rating if txn.rating else '-' }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% set pages = (entry.total_txns // 5) + (1 if entry.total_txns % 5 else 0) %}
                    {% if pages > 1 %}
                        <div class="pagination">
                            {% for p in range(1, pages + 1) %}
                                <a href="{{ url_for('view_all_users', search=search, date=date_filter, page=p) }}"
                                   class="{{ 'active' if p == current_page else '' }}">{{ p }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}

                {% else %}
                    <p class="note">No transactions found.</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</body>
</html>
